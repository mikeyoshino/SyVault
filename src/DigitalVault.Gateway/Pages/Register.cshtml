@page
@model RegisterModel
@{
    ViewData["Title"] = "สมัครสมาชิก";
    Layout = "_Layout";
}

<div class="min-h-screen flex bg-slate-50">
    <!-- Left Panel - Branding -->
    <div class="hidden lg:flex lg:w-1/2 bg-trustworthy-dark p-12 flex-col justify-between relative overflow-hidden">
        <!-- Background Pattern -->
        <div class="absolute inset-0 opacity-10">
            <div class="absolute top-0 left-0 w-96 h-96 bg-trustworthy-cyan rounded-full filter blur-3xl"></div>
            <div class="absolute bottom-0 right-0 w-96 h-96 bg-trustworthy-cyan rounded-full filter blur-3xl"></div>
        </div>

        <div class="relative z-10">
            <a href="http://localhost:5082" class="inline-flex items-center gap-2 text-white/90 hover:text-white transition text-sm font-medium">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                กลับหน้าหลัก
            </a>

            <div class="mt-16">
                <h1 class="text-6xl font-extrabold text-white mb-4 tracking-tight">อุ่นใจ</h1>
                <p class="text-2xl text-trustworthy-cyan font-semibold mb-2">Ounjai Family OS</p>
                <p class="text-white/90 mt-4 text-lg leading-relaxed">ระบบปฏิบัติการครอบครัว<br/>ที่ปลอดภัยที่สุด</p>
            </div>
        </div>

        <div class="relative z-10 space-y-5">
            <div class="flex items-start gap-4 bg-white/5 backdrop-blur-sm rounded-2xl p-4 border border-white/10">
                <div class="w-14 h-14 bg-trustworthy-cyan rounded-xl flex items-center justify-center flex-shrink-0 shadow-lg">
                    <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 2 2 0 012 2 1 1 0 102 0 4 4 0 00-4-4z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div>
                    <h3 class="text-white font-bold mb-1 text-base">Zero-Knowledge Encryption</h3>
                    <p class="text-white/80 text-sm leading-relaxed">เซิร์ฟเวอร์ไม่สามารถเข้าถึงข้อมูลของคุณได้</p>
                </div>
            </div>

            <div class="flex items-start gap-4 bg-white/5 backdrop-blur-sm rounded-2xl p-4 border border-white/10">
                <div class="w-14 h-14 bg-trustworthy-cyan rounded-xl flex items-center justify-center flex-shrink-0 shadow-lg">
                    <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div>
                    <h3 class="text-white font-bold mb-1 text-base">AES-256 Encryption</h3>
                    <p class="text-white/80 text-sm leading-relaxed">มาตรฐานการเข้ารหัสระดับธนาคาร</p>
                </div>
            </div>

            <div class="flex items-start gap-4 bg-white/5 backdrop-blur-sm rounded-2xl p-4 border border-white/10">
                <div class="w-14 h-14 bg-trustworthy-cyan rounded-xl flex items-center justify-center flex-shrink-0 shadow-lg">
                    <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                    </svg>
                </div>
                <div>
                    <h3 class="text-white font-bold mb-1 text-base">Family Sharing</h3>
                    <p class="text-white/80 text-sm leading-relaxed">แบ่งปันเอกสารกับครอบครัวอย่างปลอดภัย</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Panel - Form -->
    <div class="flex-1 flex items-center justify-center p-8">
        <div class="w-full max-w-md">
            <div class="mb-8">
                <a href="http://localhost:5082" class="lg:hidden inline-flex items-center gap-2 mb-6 text-slate-400 hover:text-trustworthy-dark transition text-sm font-medium">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    กลับหน้าหลัก
                </a>
                <h2 class="text-3xl font-bold text-trustworthy-dark leading-tight">เริ่มต้นใช้งาน</h2>
                <p class="text-slate-500 mt-2">สมัครวันนี้ ทดลองใช้ฟีเจอร์พรีเมียมฟรี 14 วัน</p>
            </div>

            @if (!string.IsNullOrEmpty(Model.ErrorMessage))
            {
                <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700 text-sm">
                    @Model.ErrorMessage
                </div>
            }

            <!-- Loading State Overlay -->
            <div id="loadingOverlay" class="hidden fixed inset-0 bg-white/90 flex-col items-center justify-center z-50">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-trustworthy-cyan mb-4"></div>
                <p class="text-slate-600 font-medium animate-pulse">กำลังสร้างกุญแจเข้ารหัส...</p>
            </div>

            <form method="post" id="registerForm" class="space-y-4">
                <!-- Hidden Fields for Encryption Data -->
                <input asp-for="EncryptedMasterKey" type="hidden" id="EncryptedMasterKey" />
                <input asp-for="KeyDerivationSalt" type="hidden" id="KeyDerivationSalt" />
                <input asp-for="KeyDerivationIterations" type="hidden" id="KeyDerivationIterations" value="100000" />

                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">อีเมล</label>
                    <input asp-for="Email" type="email" placeholder="example@email.com" required
                        class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-trustworthy-cyan/20 focus:border-trustworthy-cyan transition" />
                    <span asp-validation-for="Email" class="text-red-500 text-xs mt-1 block"></span>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">รหัสผ่าน</label>
                    <input asp-for="Password" type="password" id="password" placeholder="อย่างน้อย 8 ตัวอักษร" required
                        class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-trustworthy-cyan/20 focus:border-trustworthy-cyan transition" />
                    <span asp-validation-for="Password" class="text-red-500 text-xs mt-1 block"></span>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">ยืนยันรหัสผ่าน</label>
                    <input asp-for="ConfirmPassword" type="password" id="confirmPassword" placeholder="ยืนยันรหัสผ่าน" required
                        class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-trustworthy-cyan/20 focus:border-trustworthy-cyan transition" />
                    <span asp-validation-for="ConfirmPassword" class="text-red-500 text-xs mt-1 block"></span>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">เบอร์โทรศัพท์ (ไม่บังคับ)</label>
                    <input asp-for="PhoneNumber" type="tel" placeholder="0812345678"
                        class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-trustworthy-cyan/20 focus:border-trustworthy-cyan transition" />
                    <span asp-validation-for="PhoneNumber" class="text-red-500 text-xs mt-1 block"></span>
                </div>

                <div class="pt-2">
                    <button type="submit" id="submitBtn"
                        class="w-full bg-trustworthy-cyan text-white py-4 rounded-xl font-bold hover:bg-cyan-600 transition shadow-lg shadow-cyan-200/50">
                        สร้างบัญชีผู้ใช้
                    </button>
                </div>
            </form>

            <div class="mt-8 text-center">
                <p class="text-sm text-slate-500">มีบัญชีอยู่แล้ว? <a href="/Login" class="text-trustworthy-cyan font-bold hover:underline">เข้าสู่ระบบ</a></p>
            </div>

            <div class="mt-6 lg:hidden">
                <div class="flex items-start gap-3 text-xs text-slate-500 bg-slate-50 p-3 rounded-lg">
                    <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 2 2 0 012 2 1 1 0 102 0 4 4 0 00-4-4z" clip-rule="evenodd" />
                    </svg>
                    <span>
                        <strong>Zero-Knowledge Encryption:</strong> รหัสผ่านของคุณจะถูกใช้เพื่อสร้างกุญแจเข้ารหัสบนเครื่องของคุณเท่านั้น เซิร์ฟเวอร์จะไม่ทราบรหัสผ่านหรือกุญแจจริงของคุณ
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        const ITERATIONS = 100000;

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        async function deriveKeyFromPassword(password, salt) {
            const encoder = new TextEncoder();
            const passwordBuffer = encoder.encode(password);

            const keyMaterial = await window.crypto.subtle.importKey(
                'raw',
                passwordBuffer,
                'PBKDF2',
                false,
                ['deriveBits', 'deriveKey']
            );

            return await window.crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: ITERATIONS,
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                true,
                ['encrypt', 'decrypt']
            );
        }

        async function encryptMasterKey(masterKey, passwordKey) {
            const iv = window.crypto.getRandomValues(new Uint8Array(12));

            const encrypted = await window.crypto.subtle.encrypt(
                {
                    name: 'AES-GCM',
                    iv: iv
                },
                passwordKey,
                masterKey
            );

            const combined = new Uint8Array(iv.length + encrypted.byteLength);
            combined.set(iv);
            combined.set(new Uint8Array(encrypted), iv.length);

            return combined;
        }

        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) {
                return;
            }

            if (document.getElementById('EncryptedMasterKey').value) {
                return;
            }

            e.preventDefault();

            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');

            try {
                const masterKey = window.crypto.getRandomValues(new Uint8Array(32));
                const salt = window.crypto.getRandomValues(new Uint8Array(16));
                const passwordKey = await deriveKeyFromPassword(password, salt);
                const encryptedMasterKey = await encryptMasterKey(masterKey, passwordKey);

                document.getElementById('EncryptedMasterKey').value = arrayBufferToBase64(encryptedMasterKey);
                document.getElementById('KeyDerivationSalt').value = arrayBufferToBase64(salt);
                document.getElementById('KeyDerivationIterations').value = ITERATIONS;

                this.submit();

            } catch (err) {
                console.error("Encryption Error:", err);
                alert("เกิดข้อผิดพลาดในกระบวนการเข้ารหัสความปลอดภัย: " + err.message);

                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('loadingOverlay').classList.remove('flex');
            }
        });
    </script>
}
