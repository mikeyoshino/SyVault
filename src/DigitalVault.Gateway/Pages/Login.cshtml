@page
@model LoginModel
@{
    ViewData["Title"] = "เข้าสู่ระบบ";
    Layout = "_Layout";
}

<div class="min-h-screen flex items-center justify-center bg-slate-50 px-4 py-12">
    <div class="max-w-md w-full bg-white rounded-3xl shadow-2xl border border-slate-100 overflow-hidden">
        <div class="p-8 sm:p-12">
            <div class="text-center mb-10">
                <a href="http://localhost:5082" class="inline-flex items-center gap-2 mb-8 text-slate-400 hover:text-trustworthy-dark transition text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    กลับหน้าหลัก
                </a>
                <div class="w-16 h-16 bg-trustworthy-dark rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl shadow-blue-900/20">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                </div>
                <h2 class="text-3xl font-bold text-trustworthy-dark leading-tight">ยินดีต้อนรับกลับมา</h2>
                <p class="text-slate-500 mt-2">เข้าใช้ระบบปฏิบัติการครอบครัวของคุณ</p>
            </div>

            @if (!string.IsNullOrEmpty(Model.ErrorMessage))
            {
                <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700 text-sm">
                    @Model.ErrorMessage
                </div>
            }

            <form id="loginForm" class="space-y-6">
                @Html.AntiForgeryToken()
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">อีเมล</label>
                    <input asp-for="Email" id="email" type="email" placeholder="example@email.com" required
                        class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-trustworthy-cyan/20 focus:border-trustworthy-cyan transition" />
                    <span asp-validation-for="Email" class="text-red-500 text-xs mt-1 block"></span>
                </div>
                <div>
                    <div class="flex justify-between mb-2">
                        <label class="text-sm font-semibold text-slate-700">รหัสผ่าน</label>
                        <a href="/ForgotPassword" class="text-xs text-trustworthy-cyan hover:underline">ลืมรหัสผ่าน?</a>
                    </div>
                    <input asp-for="Password" id="password" type="password" placeholder="••••••••" required
                        class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-trustworthy-cyan/20 focus:border-trustworthy-cyan transition" />
                    <span asp-validation-for="Password" class="text-red-500 text-xs mt-1 block"></span>
                </div>

                <div class="flex items-center">
                    <input asp-for="RememberMe" id="rememberMe" type="checkbox" class="rounded border-slate-300 text-trustworthy-cyan focus:ring-trustworthy-cyan" />
                    <label for="rememberMe" class="ml-2 text-sm text-slate-600">จดจำฉันในเครื่องนี้</label>
                </div>

                <div id="loadingState" class="hidden text-center text-trustworthy-cyan text-sm font-medium animate-pulse py-2">
                    กำลังตรวจสอบข้อมูลและถอดรหัสกุญแจ...
                </div>
                <div id="formError" class="hidden text-center text-red-500 text-sm font-medium p-3 bg-red-50 rounded-xl"></div>

                <button type="button" onclick="handleLogin()" id="submitBtn"
                    class="w-full bg-trustworthy-dark text-white py-4 rounded-xl font-bold hover:bg-slate-800 transition shadow-lg">
                    เข้าสู่ระบบ
                </button>
            </form>

            <div class="mt-8 text-center">
                <p class="text-sm text-slate-500">ยังไม่มีบัญชี? <a href="/Register" class="text-trustworthy-cyan font-bold hover:underline">สมัครใช้งานฟรี</a></p>
            </div>

            <!-- Security Indicators -->
            <div class="mt-8 pt-6 border-t border-slate-100">
                <div class="flex justify-center gap-6 text-xs text-slate-500">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        <span>AES-256 Encrypted</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 2 2 0 012 2 1 1 0 102 0 4 4 0 00-4-4z" clip-rule="evenodd" />
                        </svg>
                        <span>Zero Knowledge</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            const submitBtn = document.getElementById('submitBtn');
            const loadingState = document.getElementById('loadingState');
            const formError = document.getElementById('formError');
            const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            const token = tokenInput ? tokenInput.value : '';

            if (!email || !password) {
                formError.innerText = "กรุณากรอกอีเมลและรหัสผ่าน";
                formError.classList.remove('hidden');
                return;
            }

            formError.classList.add('hidden');
            formError.innerText = '';
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            loadingState.classList.remove('hidden');

            try {
                const formData = new FormData();
                formData.append('Email', email);
                formData.append('Password', password);
                formData.append('RememberMe', rememberMe);
                formData.append('__RequestVerificationToken', token);

                const response = await fetch('/Login?ajax=true', {
                    method: 'POST',
                    body: formData,
                    headers: { 'Accept': 'application/json' }
                });

                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    throw new Error("Server returned non-JSON response. Please check server logs.");
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message || 'การเข้าสู่ระบบล้มเหลว');
                }

                const user = result.data;
                if (!user.encryptedMasterKey || !user.keyDerivationSalt) {
                    console.warn("No encryption data found for user.");
                    window.location.href = result.redirectUrl || '/';
                    return;
                }

                try {
                    console.log("Starting Key Decryption...");
                    const masterKey = await decryptMasterKey(user.encryptedMasterKey, password, user.keyDerivationSalt, user.keyDerivationIterations);
                    console.log("Key Decryption Success.");

                    const jsonKey = JSON.stringify(masterKey);
                    if (rememberMe) {
                        localStorage.setItem('masterKey', jsonKey);
                        sessionStorage.removeItem('masterKey');
                    } else {
                        sessionStorage.setItem('masterKey', jsonKey);
                        localStorage.removeItem('masterKey');
                    }

                    window.location.href = result.redirectUrl || '/';
                } catch (cryptoError) {
                    console.error("Decryption failed:", cryptoError);
                    throw new Error("รหัสผ่านถูกต้อง แต่ไม่สามารถถอดรหัสข้อมูลได้");
                }
            } catch (error) {
                console.error(error);
                formError.innerText = error.message;
                formError.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                loadingState.classList.add('hidden');
            }
        }

        async function decryptMasterKey(encryptedMasterKeyBase64, password, saltBase64, iterations) {
            const enc = new TextEncoder();
            const passwordKey = await window.crypto.subtle.importKey("raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]);
            const salt = Uint8Array.from(atob(saltBase64), c => c.charCodeAt(0));
            const derivedKey = await window.crypto.subtle.deriveKey(
                { name: "PBKDF2", salt: salt, iterations: iterations, hash: "SHA-256" },
                passwordKey,
                { name: "AES-GCM", length: 256 },
                false,
                ["decrypt"]
            );
            const encryptedBytes = Uint8Array.from(atob(encryptedMasterKeyBase64), c => c.charCodeAt(0));
            const iv = encryptedBytes.slice(0, 12);
            const ciphertext = encryptedBytes.slice(12);
            const decryptedBuffer = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, derivedKey, ciphertext);
            const decryptedBytes = new Uint8Array(decryptedBuffer);
            return btoa(String.fromCharCode.apply(null, decryptedBytes));
        }
    </script>
}